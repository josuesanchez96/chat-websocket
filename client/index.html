<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MiPrimerChat</title>

  <script type="module">
    //aqui importaremos la versión ESM de Socket.IO cliente desde CDN
    import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js'

    //aqui se captura todos los elementos de la UI que se usará
    //contenedor del chat, lista de mensajes, formulario y input de texto, "dialogo" para pedir
    //nombre, su formulario/input y el indicador de "escribiendo..."
    const chatSection = document.getElementById('chat')
    const messages = document.getElementById('messages')
    const form = document.getElementById('form')
    const input = document.getElementById('input')

    const usernameDialog = document.getElementById('username-dialog')
    const usernameForm = document.getElementById('username-form')
    const usernameInput = document.getElementById('username-input')

    const typingBox = document.getElementById('typing-indicator')

    //aqui estan las variables qeu se compartirán entre funciones
    let socket
    let myUsername = null

    // Con Función askUsername() siempre pedirá nombre al entrar al enlace
    const askUsername = () => {
      usernameDialog.hidden = false
      usernameInput.value = ''
      usernameInput.focus()
      return new Promise((resolve) => {
        usernameForm.addEventListener('submit', (e) => {
          e.preventDefault()
          const name = usernameInput.value.trim()
          if (!name) return
          usernameDialog.hidden = true
          resolve(name)
        }, { once: true })
      })
    }

    //aquí guarda el nombre en myUsername
    //Crea la conexión al servidor con autenticación embebida 
    //muestra la sección del chat
    const initSocket = (username) => {
      myUsername = username

      socket = io({
        auth: {
          username,
          serverOffset: 0
        }
      })

      chatSection.hidden = false

      //aqui escucha el evento chat message emitido pr el servidor
      //se usa textContent para prevenir inyecciones
      //calcula si se esta al fondo antes de agregar el mensaje
      socket.on('chat message', (msg, serverOffset, fromUsername) => {
        const atBottom = messages.scrollTop + messages.clientHeight >= messages.scrollHeight - 4
        
        const li = document.createElement('li')
        const p = document.createElement('p')
        const small = document.createElement('small')
        p.textContent = msg
        small.textContent = fromUsername ?? 'anonymous'
        li.appendChild(p)
        li.appendChild(small)
        messages.appendChild(li)

        if (atBottom){
            messages.scrollTop = messages.scrollHeight 
        }

      })

      // aqui intercepta el submit, valida text no vacío, emite chat message al servidor y limpia el input
      //llama stopTyping para notificar que se deja de escribir al enviar
      form.addEventListener('submit', (e) => {
        e.preventDefault()
        const text = input.value.trim()
        if (!text) return
        socket.emit('chat message', text)
        input.value = ''
        stopTyping() // dejar de “escribir” al enviar
      })

      // === Indicador "escribiendo..." ===
      // (1) Entrante: otros usuarios escribiendo
      //mantiene un conjunto con los usuarios que están escribiendo
      //construye el mensaje dinámico y muestra/oculta el contenedor typingBox
      const currentlyTyping = new Set()

      const renderTyping = () => {
        if (currentlyTyping.size === 0) {
          typingBox.style.visibility = 'hidden'
          typingBox.textContent = ''
          return
        }
        const names = Array.from(currentlyTyping)
        let text = ''
        if (names.length === 1) text = `${names[0]} está escribiendo…`
        else if (names.length === 2) text = `${names[0]} y ${names[1]} están escribiendo…`
        else text = `${names[0]}, ${names[1]} y ${names.length - 2} más están escribiendo…`

        typingBox.style.visibility = 'visible'
        typingBox.textContent = text
      }

      //aqui recibe del servidor quién está escribiendo o dejo de escribir
      //ignora el usuario propio
      //actualiza el set y re-renderiza
      socket.on('typing', ({ username: u, typing }) => {
        if (!u || u === myUsername) return
        if (typing) currentlyTyping.add(u)
        else currentlyTyping.delete(u)
        renderTyping()
      })

      // (2) Saliente: yo escribiendo
      let isTyping = false
      let typingTimeout
      const TYPING_DELAY_MS = 1500

      const startTyping = () => {
        if (!isTyping) {
          isTyping = true
          socket.emit('typing', { typing: true })
        }
        clearTimeout(typingTimeout)
        typingTimeout = setTimeout(() => {
          stopTyping()
        }, TYPING_DELAY_MS)
      }

      const stopTyping = () => {
        if (isTyping) {
          isTyping = false
          socket.emit('typing', { typing: false })
        }
        clearTimeout(typingTimeout)
      }

      input.addEventListener('input', startTyping)
      input.addEventListener('blur', stopTyping)
      // === Fin indicador "escribiendo..." ===
    }

    // Flujo principal
    //al cargar el script: pide nombre siempre y, cuando lo obtiene, conecta el socket y activa 
    //toda lógica
    (async () => {
      const username = await askUsername()
      initSocket(username)
    })()
  </script>

  <style>
    *,
    *::before,
    *::after { box-sizing: border-box; }

    :root { color-scheme: dark; }

    html, body {
        height: 100%;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      display: grid;
      place-content: center;
      height: 100vh;
      padding: 36px 36px 100px 36px;
      grid-template-rows: 1fr;
      color: #eee;

      min-height: 100vh;
      min-height: 100dvh;

      background: 
        linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.45)),
        url(img/fondo.jpg) center / cover no-repeat fixed;
    }

    /* diálogo */
    #username-dialog[hidden] { display: none; }
    #username-dialog {
      width: 350px;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      background: #111;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    #username-dialog h2 { margin: 0 0 8px; font-size: 1.1rem; }
    #username-dialog p { margin: 0 0 12px; color: #bbb; font-size: .9rem; }
    #username-form { display: grid; gap: 8px; }
    #username-input {
      border-radius: 9999px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      padding: 10px 14px;
    }
    #username-form button {
      background: #09f;
      color: #fff;
      border: 0;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
    #username-form button:hover { background: #0cf; }

    /* chat */
    #chat[hidden] { display: none; }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 8px 0;
      overflow-y: auto;
      flex: 1;
      scroll-behavior: smooth;
    }
    #messages > li { padding: .5rem 1rem; }
    #messages > li:nth-child(odd) { background: #000; }

    #chat {
      border: 1px solid #333;
      border-radius: 8px;
      overflow: hidden;
      width: 350px;
      height: 520px;      
      background: #0b0b0b;
      display: flex;
      flex-direction: column;
    }

    #chat h2{
        text-align: center;
        margin-top: 0;
    }

    #form {
      
      display: flex;
      gap: 8px;
      
      padding: 6px;
      
      
      background: #0b0b0b;
      border-top: 1px solid #222;
    }

    #input {
      border-radius: 9999px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      flex: 1;
      margin: 4px;
      padding: 0 12px;
    }
    #input:focus { outline: 0; }

    #form > button {
      background: #09f;
      color: #fff;
      border: 0;
      margin: 4px;
      border-radius: 8px;
      padding: 0 12px;
      cursor: pointer;
    }
    #form > button:hover { background: #0cf; }

    /* Indicador escribiendo... */
    #typing-indicator {
      min-height: 20px;
      padding: 6px 12px;
      color: #bbb;
      font-size: .9rem;
      border-top: 1px solid #222;
      background: #0b0b0b
      
    }
    #typing-indicator[hidden] { display: none; }
  </style>
  
</head>
<body>
  <!-- Diálogo para pedir nombre SIEMPRE -->   <!-- -->
  <!-- Bloque de UI donde el usuario elige su nombre antes de entrar al chat -->
  <section id="username-dialog">
    <h2>Elige tu nombre</h2>
    <p>Este nombre aparecerá como tu usuario en el chat.</p>
    <form id="username-form">
      <input id="username-input" type="text" placeholder="Tu nombre" autocomplete="off" maxlength="30" />
      <button type="submit">Continuar</button>
    </form>
  </section>

  <!-- Chat -->
  <!-- interfaz del chat, donde se muestran los mensajes, el indicador de  -->
  <!-- "escribiendo.. " y el formulario para enviar texto -->
  <section id="chat" hidden>
    <h2>Mi Primer Chat</h2>
    <ul id="messages"></ul>
    <div id="typing-indicator"></div>
    <form id="form">
      <input type="text" name="message" id="input" placeholder="Escribe un mensaje" autocomplete="off" />
      <button type="submit">Enviar</button>
    </form>
  </section>

  
</body>
</html>
